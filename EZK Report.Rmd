---
title: "EZK Report"
author: "Net Zhang"
date: "4/21/2021"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	paged.print=FALSE
)
library(tidyverse)
library(rjags)
library(coda)
```

```{r results = FALSE}
flu_data <- read.table("data/flu.txt", header = T)
flu_data <- as_tibble(flu_data) %>%
  mutate(
    country_code = case_when(
      Country == "A" ~ 1,
      Country == "B" ~ 2,
      Country == "C" ~ 3,
      Country == "D" ~ 4,
      Country == "E" ~ 5,
      Country == "F" ~ 6,
      Country == "G" ~ 7,
      Country == "H" ~ 8,
      Country == "I" ~ 9,
      Country == "J" ~ 10
    )
  )

nTotal <- nrow(flu_data)
nCountry <- length(unique(flu_data$Country))

data_list <- list(
  "y" = flu_data$Infected,
  "x" = flu_data$EZK,
  "country" = flu_data$country_code,
  "nTotal" = nTotal,
  "nCountry" = nCountry
)

model_params <- c(
   "alpha", 
    "beta",
    "mu_alpha",
    "mu_beta",
    "sigma_alpha",
    "sigma_beta"
)

param_init_values <- list( 
  "mu_alpha" = 0,
  "mu_beta" = 0,
  "sigma_alpha" = 1,
  "sigma_beta" = 1)


niters = 10000
nburns = 2500
nadapt = 2500
nchains=2

mod <- "model {
  # Prior =========================================================
  mu_alpha ~ dnorm(0, 1/100)
  sigma_alpha ~ dunif(0, 3)
  mu_beta ~ dnorm(0, 1/100)
  sigma_beta ~ dunif(0, 3)
  
  for (i in 1:nCountry) {
    alpha[i] ~ dnorm(mu_alpha, 1/(sigma_alpha)^2)
    beta[i] ~ dnorm(mu_beta, 1/(sigma_beta)^2)
  }
  
  # Likelihood =====================================================
  for (i in 1:nTotal) {
    logit_theta[i] <- alpha[country[i]] + beta[country[i]] * x[i]
    theta[i] <- exp(logit_theta[i])/(1+exp(logit_theta[i]))
    y[i] ~ dbern(theta[i])
  }
}"


model_fit <- jags.model(textConnection(mod),
               data = data_list, 
               inits = param_init_values, 
               n.chains = nchains, 
               n.adapt = nadapt)


fit_samples <- coda.samples(
  model_fit,
  model_params,
  n.iter = niters
)
```


# Background & Definitions 

The World Health Organization sponsored a small clinical trial run in 10 countries where the K9C9 virus in endemic. The goal of this project is to propose a Bayesian hierarchical model for K9C9 status basing on the EZK test results. The model can later be applied to examine the diagnostic ability of the EZK test.


At each of the $N^{c}$ countries, a highly accurate and expensive diagnostic test was given by $N^{total} = 100$ randomly selected participants. Let $Y_{ic}$ be the indicator variable of whether the $i^{th}$ participant at the $c^{th}$ country is being infected by K9C9, for $i = 1,..., N^{total}$. Meanwhile, let $x_{ic}$ be the indicator variable that the $i^{th}$ person's test result, where $x_{ic} = 1$ indicate that the individual is tested positive for K9C9. 

\[
Y = \{Y_{ic}: i = 1,...,N^{total}, c = 1,...,N^{C}\}
\]

\[
X = \{x_{ic}: i = 1,...,N^{total}, c = 1,...,N^{C}\}
\]

First, we assume that the likelihood can be written as below:

\[
p(y|\alpha, \beta) = \prod_{c=1}^{N^{c}}\prod_{i=1}^{N^{total}} p(y_{ic}|\alpha_{c}, \beta_{c}),
\]

where for $i = 1,...,N^{total}, c = 1,...,N^{C}$

\[
Y_{ic}|\alpha_{c},\beta_{c} \sim Bern(\theta_{ic})
\]

and

\[
logit(\theta_{ic}) = log(\frac{\theta_{ic}}{1-\theta_{ic}}) = \alpha_{c} + \beta_{c}x_{ic}
\]

For $\alpha = (\alpha_1,...,\alpha_{N^{c}})$ and $\beta = (\beta_1,...,\beta_{N^{c}})$, we assume that:

\[
p(\alpha, \beta|\mu_{\alpha}, \sigma_{\alpha}^{2}, \mu_{\beta}, \sigma_{\beta}^{2}) = \prod_{c = 1}^{N^c}p(\alpha_{c}|\mu_{\alpha}, \sigma_{\alpha}^{2})p(\beta_{c}|\mu_{\beta}, \sigma_{\beta}^{2})
\]

where for all $c = 1,...,N^{c}$,

\[
\alpha_{c}|\mu_{\alpha}, \sigma_{\alpha}^{2} \sim N(\mu_{\alpha}, \sigma_{\alpha}^{2})
\]

and 

\[
\beta_{c}|\mu_{\beta}, \sigma_{\beta}^{2} \sim N(\mu_{\beta}, \sigma_{\beta}^{2})
\]

and lastly, we assume the parameters below are independent, that is to say,

\[
p(\mu_{\alpha}, \sigma_{\alpha}^{2}, \mu_{\beta}, \sigma_{\beta}^{2}) = 
p(\mu_{\alpha}) p(\sigma_{\alpha}^{2}) p(\mu_{\beta}) p(\sigma_{\beta}^{2})
\]

where the priors are specified as below:

\[
\mu_{\alpha} \sim N(0, 100), \sigma_{\alpha} \sim Unif(0, 3)
\]

\[
\mu_{\beta} \sim N(0, 100), \sigma_{\beta} \sim Unif(0, 3)
\]



# Appendix

**rjags model scripts: **

```
model {
  # Prior =========================================================
  mu_alpha ~ dnorm(0, 1/100)
  sigma_alpha ~ dunif(0, 3)
  mu_beta ~ dnorm(0, 1/100)
  sigma_beta ~ dunif(0, 3)
  
  for (i in 1:nCountry) {
    alpha[i] ~ dnorm(mu_alpha, 1/(sigma_alpha)^2)
    beta[i] ~ dnorm(mu_beta, 1/(sigma_beta)^2)
  }
  
  # Likelihood ====================================================
  for (i in 1:nTotal) {
    logit_theta[i] <- alpha[country[i]] + beta[country[i]] * x[i]
    theta[i] <- exp(logit_theta[i])/(1+exp(logit_theta[i]))
    y[i] ~ dbern(theta[i])
  }
}
```
















































